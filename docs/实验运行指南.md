# 实验运行指南（手动跑 / 配参 / 查结果）

本指南面向“手动跑实验”的日常工作流：如何选配置、跑 Stage I–III + Eval、做 A/B、复用离线产物，以及去哪里看结果。

## 0. 术语与入口

- 统一入口：`run.py`
- 离线三阶段：`mine`（Stage I）→ `select`（Stage II）→ `memory`（Stage III）
- 在线评测：`eval`
- 个例调试：`case`
- 配置：`configs/*.yaml`
- 输出：`outputs/<run_name>/<run_id>/...`（每次运行都会落盘 `config_resolved.json`）

## 1. 环境与数据

- 建议在 conda 环境 `easysteer` 里跑（EasySteer/vLLM 依赖在其中）。
- 大多数 stage 需要 GPU；保持单进程单卡（`model.tensor_parallel_size: 1`），多卡用“多进程并行”或 `suite`。
- 常用环境变量：
  - `CUDA_VISIBLE_DEVICES=0`
  - `TOKENIZERS_PARALLELISM=false`
- 数据默认根目录（可在配置里改 `task.data_root`）：`datasets`

## 2. 最常用命令（单数据集）

### 2.0 推荐从哪个配置开始

- 快速 smoke：`configs/debug.yaml`
- GSM8K 小规模迭代（更稳的默认起点）：`configs/gsm8k_recommended_small.yaml`
- GSM8K 论文/投稿起点：`configs/gsm8k_recommended_paper.yaml`
- 已有实验与配置汇总：`docs/实验结果与配置汇总.md`

### 2.x 预算（token）建议（很重要）

- **普通数据集**：`T_max >= 1024`（推荐 `2048`，用于主结论/最终表格）
- **数学类数据集**（如 `math500` / `aime_2024` / `math`）：`T_max >= 4096` 才能避免普遍截断

### 2.1 查看 CLI

```bash
conda run -n easysteer python run.py -h
```

### 2.2 快速 smoke（小样本）

```bash
conda run -n easysteer python run.py --config configs/debug.yaml eval
```

### 2.3 跑完整流程（推荐手动顺序）

```bash
CUDA_VISIBLE_DEVICES=0 conda run -n easysteer python run.py --config <cfg.yaml> mine
CUDA_VISIBLE_DEVICES=0 conda run -n easysteer python run.py --config <cfg.yaml> select
CUDA_VISIBLE_DEVICES=0 conda run -n easysteer python run.py --config <cfg.yaml> memory
CUDA_VISIBLE_DEVICES=0 conda run -n easysteer python run.py --config <cfg.yaml> eval
```

### 2.4 复用同一次 run_id / 恢复运行

- 显式指定 run_id（保证四个 stage 写到同一个目录）：
  - `--run-id 20251216_130915`
- 恢复最新一次：
  - `--run-id latest`
  - 依赖 `outputs/<run_name>/LATEST` 指针（通常在 `select` 阶段写入/更新）。

## 3. 多数据集 suite（多 GPU，一卡一任务）

- 直接跑现成配置：

```bash
conda run -n easysteer python run.py --config configs/suite_tiny.yaml suite --gpus "0,1"
```

- 结果聚合输出在：
  - `outputs/_suite/<suite_id>/tables/suite_main_results.csv`
  - `outputs/_suite/<suite_id>/tables/suite_ablation_long.csv`（若启用 ablations）

## 4. Case 级调试（只跑几个样本，输出 Markdown）

示例：

```bash
conda run -n easysteer python run.py --config configs/debug.yaml --run-id <RID> case \
  --example-ids 0,6 --max-new-tokens 256 --methods greedy,esm --tag dbg
```

输出：

- `outputs/<run_name>/<run_id>/cases/<tag>_..._T256.md`
- 以及对应的 `outputs/<run_name>/<run_id>/eval/<tag>_.../per_example.jsonl`

## 5. 配置文件怎么改（YAML）

配置 schema 见 `esm/config.py`；每次运行会把最终配置写到：

- `outputs/<run_name>/<run_id>/config_resolved.json`

### 5.1 顶层结构（必须项）

```yaml
seed: 0
model: {...}
task: {...}
prompt: {...}
decode: {...}
control_points: {...}
offline_mine: {...}
offline_select: {...}
offline_memory: {...}
online: {...}
eval: {...}
outputs: {...}
```

### 5.2 常用可调参数速查

#### model（显存/稳定性相关）

- `model.name_or_path`：模型路径
- `model.gpu_memory_utilization`：vLLM 显存占用上限（OOM 先降它）
- `model.max_model_len`：KV cache 上限（不需要 32k 就别开太大）
- `model.max_num_seqs`：并发序列上限（默认 64；OOM 可降）

#### task（数据与样本量）

- `task.dataset`：`gsm8k` / `arc-c` / `svamp` / `math500` / `aime_2024` / ...
- `task.train_split`, `task.eval_split`
- `task.max_train_examples`, `task.max_eval_examples`：`null` 表示全量

#### prompt（模板）

- `prompt.template`：见 `esm/data/prompts.py`，常用：
  - `gsm8k_0shot`, `gsm8k_0shot_compact`
  - `arc_0shot`
  - `math_0shot`, `strategyqa_0shot`

#### decode（默认生成超参；Stage III 也会用到 max_new_tokens）

- `decode.max_new_tokens`：默认预算（Stage III memory 的 `T_max` 用它）
- `decode.temperature`, `decode.top_p`, `decode.logprobs`

#### control_points（ESM 控制点划分）

- `control_points.segment_delimiter`：分段分隔符（默认空行：`\n\n`）
- `control_points.M`：最大控制点数（最多 M 段）

#### offline_mine（Stage I：挖记忆条目）

- `offline_mine.K`：每题采样 rollouts 数
- `offline_mine.K_pos`, `offline_mine.K_neg`：正/负集合大小（默认按 correct vs incorrect）
- `offline_mine.max_new_tokens`：rollout 预算
- `offline_mine.keep_top_C`：候选池大小（按质量 Q 排序截断）
- `offline_mine.require_correct_and_incorrect`：是否要求“正确 vs 错误”对比（默认 true）
- `offline_mine.pos_source`：`rollout` / `gold` / `rollout_or_gold`
- 质量定义：`Q = \bar{R}_P - \bar{R}_N`（不乘 `||v||`，`v` 本身不做归一化）

#### offline_select（Stage II：选工具库）

- `offline_select.B`：library 大小
- `offline_select.method`：`dpp` / `top` / `random`
- `offline_select.lambda_diversity`：多样性权重（DPP）
- `offline_select.min_per_control_point`：每个 m 至少保留多少工具（覆盖性）

#### offline_memory（Stage III：建记忆索引）

- `offline_memory.normalize_keys`：是否对 key 隐层做 L2 normalize（默认 true；用于 cosine 相似性）

#### online（ESM 在线策略）

- `online.variant`：`esm` / `no_memory` / `no_probing`（ablation）
- `online.k_retrieve`：每步从 memory 里取 top-k 相似条目
- `online.L`：每步最多探测的候选条目数（另加 null）
- `online.probe_tokens`：每个候选固定 probe token 数（例如 4–8）
- `online.beta`, `online.rho`：打分权重（`Score_i = beta * \hat{A}_i + rho * (logprob_i - logprob_null)`）
- `online.k_scale`：注入强度缩放（最终注入是 `k_scale * Score_i * v_i`，不做归一化）
- `online.tau_null`：估计优势不足则强制 null（更保守）
- `online.min_sim`, `online.min_entries`：检索置信门控（避免“无记忆硬 probe”）

#### eval（评测与复用离线产物）

- `decode.max_new_tokens`：评测的 `T_max`（当前只跑单点，不做 budgets sweep）
- `eval.methods`：`["greedy","esm"]`
- `eval.ablations`：例如 `["no_memory","no_probing"]`（在同一个 `T_max` 跑）
- `eval.artifact_run_dir`：复用离线产物（包含 `library/` + `memory/` 的 run_dir）
  - 支持 `outputs/<run_name>/latest`，会通过 `outputs/<run_name>/LATEST` 解析到具体 run_id。

#### outputs（输出路径与组织）

- `outputs.root_dir`：输出根目录
- `outputs.run_name`：实验名（建议按数据集/设置起名）
- `outputs.run_id`：运行 ID（不填则自动用时间戳；也可用 `latest`）

### 5.3 推荐工作流（离线一次 + 在线多次）

1. 先跑一次离线：`mine → select → memory`
2. 再复制一个 eval-only 配置，设置 `eval.artifact_run_dir: "outputs/<离线run_name>/latest"`，只改 `online.*` 和 `decode.max_new_tokens` 反复 `eval`。

## 6. 结果在哪里看（最常用文件）

在 `outputs/<run_name>/<run_id>/` 下：

- `config_resolved.json`：本次运行的最终配置（可复现）
- `logs/run.log`：运行日志
- `tables/main_results_single.csv`：单数据集主表行（`T_max = decode.max_new_tokens`）
- `tables/ablation.csv`：ablation 结果（若启用）
- `tables/diagnostics_T*.csv|json`, `figures/tokens_hist_T*.pdf`：截断率/开销等诊断
- `cases/cases_T*.md`：改善/退化案例（当同时跑 greedy+esm）
- `eval/<tag>/per_example.jsonl`：每题详细输出（ESM 还含 steps/tokens_used/probe_tokens_used/budget_used）
- 离线产物：
  - `mine/`：`rollouts.jsonl`, `candidates.jsonl`, `keys/*.pt`, `vectors/*.pt`
  - `library/`：`library.jsonl`, `keys/*.pt`, `vectors/*.pt`
  - `memory/`：`keys.npy`, `entries.jsonl`, `meta.txt`

## 7. 常见问题（排障）

- OOM：先降 `model.gpu_memory_utilization`，再降 `model.max_model_len` / `model.max_num_seqs`；离线再降 `offline_mine.K` / `offline_mine.max_new_tokens`；在线再降 `online.L` / `online.probe_tokens`。
- 精度偏低但 `finish_reason=length` 很多：把 `decode.max_new_tokens` 提到 `1024/2048`（数学类至少 `4096`），或换更精简的 prompt（如 `gsm8k_0shot_compact`）。
- `--run-id latest` 报错：说明 `outputs/<run_name>/LATEST` 不存在或为空；先跑过一次 `select`（或在 YAML/CLI 里显式指定具体 run_id）。
